{% extends "base.html" %}
{% block title %}Qu√©t m√£ QR{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
    #reader-wrapper {
        width: 100%;
        max-width: 420px;
        margin: 0 auto;
    }

    #reader {
        width: 100%;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        background: #000;
    }

    .scan-container {
        text-align: center;
        margin-top: 20px;
    }

    .scan-subtitle {
        color: #9aa0b5;
        font-size: 0.9rem;
    }

    .action-buttons {
        margin-top: 16px;
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .btn-secondary-custom {
        background: #4e54c8;
        color: white !important;
        border: none;
        border-radius: 14px;
        padding: 10px 18px;
        font-weight: 600;
    }

    .btn-secondary-custom:hover {
        opacity: .9;
    }

    .btn-scan-again {
        border-radius: 14px;
        padding: 10px 18px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="scan-container">
    <h2 class="fw-bold mb-1">Qu√©t m√£ QR</h2>
    <p class="scan-subtitle mb-3">
        Camera sau s·∫Ω t·ª± b·∫≠t ƒë·ªÉ qu√©t, m·ªói l·∫ßn nh·∫≠n m√£ s·∫Ω t·∫°m d·ª´ng ƒë·ªÉ hi·ªÉn th·ªã k·∫øt qu·∫£.
    </p>

    <div id="reader-wrapper" class="mb-3">
        <div id="reader"></div>
    </div>

    <div id="scan-result" class="mt-2"></div>

    <div class="action-buttons">
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary-custom">
            ‚¨Ö Quay v·ªÅ Dashboard
        </a>
        <button id="btn-scan-again"
                type="button"
                class="btn btn-app-primary btn-scan-again"
                style="display:none;"
                onclick="startScanner()">
            üîÑ Qu√©t ti·∫øp
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let html5Qr = null;
let scanning = false;

function startScanner() {
    if (!html5Qr) {
        html5Qr = new Html5Qrcode("reader");
    }

    // Hi·ªán khung camera, ·∫©n k·∫øt qu·∫£ & n√∫t qu√©t l·∫°i
    document.getElementById("reader-wrapper").style.display = "block";
    document.getElementById("scan-result").innerHTML = "";
    document.getElementById("btn-scan-again").style.display = "none";

    const config = {
        fps: 10,
        qrbox: { width: 240, height: 240 }
    };

    scanning = true;

    // ∆Øu ti√™n camera sau
    html5Qr.start(
        { facingMode: { exact: "environment" } },
        config,
        onScanSuccess
    ).catch(function (err) {
        console.log("Kh√¥ng m·ªü ƒë∆∞·ª£c camera sau, th·ª≠ camera m·∫∑c ƒë·ªãnh...", err);

        // fallback cho thi·∫øt b·ªã kh√¥ng c√≥ camera sau
        html5Qr.start(
            { facingMode: "environment" },
            config,
            onScanSuccess
        ).catch(function (err2) {
            scanning = false;
            document.getElementById("scan-result").innerHTML =
                '<div class="alert alert-danger app-alert">Kh√¥ng m·ªü ƒë∆∞·ª£c camera: ' + err2 + '</div>';
        });
    });
}

function stopScanner() {
    if (html5Qr && scanning) {
        scanning = false;
        html5Qr.stop().then(function () {
            console.log("Camera stopped");
        }).catch(function (err) {
            console.log("L·ªói stop camera:", err);
        });
    }
}

function onScanSuccess(qrText) {
    if (!scanning) return;  // tr√°nh double event
    scanning = false;

    // D·ª´ng camera & ·∫©n khung qu√©t
    stopScanner();
    document.getElementById("reader-wrapper").style.display = "none";

    // Hi·ªán tr·∫°ng th√°i x·ª≠ l√Ω
    document.getElementById("scan-result").innerHTML =
        '<div class="alert alert-info app-alert">ƒêang x·ª≠ l√Ω m√£ <b>' + qrText + '</b>...</div>';

    fetch("{{ url_for('scan') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ qr_code: qrText })
    })
    .then(function(res) {
        return res.json().then(function(data) {
            return { ok: res.ok, body: data };
        });
    })
    .then(function(r) {
        if (r.ok) {
            document.getElementById("scan-result").innerHTML =
                '<div class="alert alert-success app-alert">' + r.body.message + '</div>';
        } else {
            document.getElementById("scan-result").innerHTML =
                '<div class="alert alert-danger app-alert">' + r.body.message + '</div>';
        }
        // Hi·ªán n√∫t "Qu√©t ti·∫øp" sau khi ƒë√£ c√≥ k·∫øt qu·∫£
        document.getElementById("btn-scan-again").style.display = "inline-block";
    })
    .catch(function(err) {
        document.getElementById("scan-result").innerHTML =
            '<div class="alert alert-danger app-alert">L·ªói k·∫øt n·ªëi server: ' + err + '</div>';
        document.getElementById("btn-scan-again").style.display = "inline-block";
    });
}

document.addEventListener("DOMContentLoaded", startScanner);
</script>
{% endblock %}
