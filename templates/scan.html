{% extends "base.html" %}
{% block title %}Scan QR{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
#reader { width: 100%; max-width: 400px; margin: auto; }
</style>
{% endblock %}

{% block content %}
<div class="text-center mb-3">
  <h3 class="fw-bold">Quét mã QR</h3>
  <p class="text-muted">Hướng camera vào mã QR để điểm danh.</p>
</div>

<div id="reader"></div>

<div id="scan-result" class="mt-3"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  function onScanSuccess(qrCodeMessage) {
    document.getElementById("scan-result").innerHTML =
      `<div class="alert alert-info">Đang xử lý mã: <strong>${qrCodeMessage}</strong>...</div>`;

    fetch("{{ url_for('scan') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ qr_code: qrCodeMessage }),
    })
    .then(res => res.json().then(data => ({ ok: res.ok, body: data })))
    .then(r => {
      if (r.ok) {
        document.getElementById("scan-result").innerHTML =
          `<div class="alert alert-success">${r.body.message}</div>`;
      } else {
        document.getElementById("scan-result").innerHTML =
          `<div class="alert alert-danger">${r.body.message}</div>`;
      }
    });
  }

  const html5Qr = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
  html5Qr.render(onScanSuccess);
});
</script>
{% endblock %}
